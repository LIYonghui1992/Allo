<style>
.cart_title{width:160px;float:left;color:#FFF;font-size:18px;text-align:center;line-height:50px;}
/*.cart_title2{width:160px;float:left;color:#FFF;font-size:18px;margin-top:5px;text-align:center;line-height:20px;}*/

.field_div{width:160px;float:left;color:#666;font-size:14px;text-align:center;padding-top:20px;}
.item_div{margin:0px auto; width:1080px;height:87px;margin-top:20px;margin-bottom:20px;border-bottom:1px solid #DDD;}
.footer{background-color:#884697}
.footer .country {BACKGROUND-COLOR: #884697;}
</style>

<div class="fmian">
<div class="layout_list">
	 <div style="margin:0px auto; width:1080px;height:89px;">
  	<img src="../Public/image/DN_logo.png" style="width:260px;height:86px;"/> 
	 </div>
  

  <!-- display:none; -->
			<div id="msgbox" style="display:none;margin:0px auto;width:1080px;height:50px;margin-top:20px;border:1px solid #e60012;
				background-color:#fff4f9;">
				<div style="width:23px;height:23px;margin-top:15px;margin-left:10px;float:left;">
					<img src="../Public/image/error.jpg" style="width:23px;height:23px;"/>
				</div>
				<div style="height:23px;margin-top:17px;margin-left:15px;float:left;">
					<font id="msg" style="font-size:12px;font-weight:bold;color:#e60012;"></font>
				</div>
				
			</div>
			
			
			<div>{$Thinkphp.ccokie.order_arr}</div>
			<div id="shipping" style="margin:0px auto;width:1080px;margin-top:42px;"> 
				<img src="../Public/image/checkout_icon1.png" style="width:16px;height:23px;float:left;padding-left:10px;"/>
				<font style="font-size:16px;font-weight:bold;color:#884697;padding-left:5px;">Shipping Address</font>				
			</div>
			
			<div id="shipping-2" style="margin:0px auto;width:1080px;height:450px;margin-top:10px;border-top-width: 1px;border-top-style: solid;border-top-color: #884697;">
				
				<div class="shipping-div" style="margin-top:15px;">
					<font style="font-size:14px;font-weight:bold;font-color:#666666;">Shipping Address</font>
				</div>
				<div class="shipping-div">
					<div class="shipping-field"><font style="font-size:12px; width:50px;">Name*</font></div>
					<input name="firstname" id="firstname"  type="text" class="shipping-input" style="width:238px;" value="First Name"
					 onfocus="if (value =='First Name'){value ='';this.style.color='#333'}" onblur="if (value ==''){value='First Name';this.style.color='#999'}"
					 />
					<input name="lastname" type="text" id="lastname" class="shipping-input" style="width:238px; margin-left:10px;" value="Last Name" 
					onfocus="if (value =='Last Name'){value ='';this.style.color='#333'}" onblur="if (value ==''){value='Last Name';this.style.color='#999'}"/>
				</div>

				<div class="shipping-div">
					<div class="shipping-field"><font style="font-size:12px;width:50px;">Phone*</font></div>
					<input name="phone" id="phone" type="text" class="shipping-input"  value="Your Phone Number" 
					onfocus="if (value =='Your Phone Number'){value ='';this.style.color='#333'}" onblur="if (value ==''){value='Your Phone Number';this.style.color='#999'}"/>
				</div>
				<div class="shipping-div">
				  <div class="shipping-field"><font style="font-size:12px;width:50px;">Company</font></div>
				  <input name="company" id="company" type="text" class="shipping-input"  value="Company Name(optional)"  
				  onfocus="if (value =='Company Name(optional)'){value ='';this.style.color='#333'}" onblur="if (value ==''){value='Company Name(optional)';this.style.color='#999'}"/>
				</div>
				<div class="shipping-div">
					<div class="shipping-field"><font style="font-size:12px;">Address*</font></div>
					<input name="address" id="address" type="text" class="shipping-input"  value="Address"  
					onfocus="if (value =='Address'){value ='';this.style.color='#333'}" onblur="if (value ==''){value='Address';this.style.color='#999'}"/>
				</div>

				<div class="shipping-div">
					<div class="shipping-field"><font style="font-size:12px;">PostalCode*</font></div>
					<input name="postcode" id="postcode" type="text" class="shipping-input" style="width:238px;" value="Postal Code" 
					 onfocus="if (value =='Postal Code'){value ='';this.style.color='#333'}" onblur="if (value ==''){value='Postal Code';this.style.color='#999'}"/>
					 <input name="city" type="text" id="city" class="shipping-input" style="width:238px;margin-left:10px;" value="City" 
					onfocus="if (value =='City'){value ='';this.style.color='#333'}" onblur="if (value ==''){value='City';this.style.color='#999'}"/>
				</div>

				<div class="shipping-div">
					<div class="shipping-field"><font style="font-size:12px;">Country*</font></div>
					
						<select id="countrylist" class="shipping-input" style="width:512px;" onchange="ship_price();" >
						  <option value="-1" selected>Choose your country</option>
						   <volist name="country_list" id="vo"  >
						   	<option value="{$vo.id}">{$vo.title}</option>
						   </volist>
					   </select>
					
				</div>
			</div>
	<!-- end shipping-2  <div class="shipping-input"></div>  -->


<!--payment-->
			<div id="payment" style="margin:0px auto;width:1080px;"> 
				<img src="../Public/image/checkout_icon2.png" style="width:28px;height:22px;float:left;padding-left:10px;" />
				<font style="font-size:16px;font-weight:bold;color:#884697;padding-left:5px;">Payment</font>
			</div>
			<div id="payment-2" style="margin:0px auto;width:1080px;height:120px;margin-top:10px;
				border-top-width: 1px;border-top-style: solid;border-top-color: #884697;"> 
				<div class="shipping-div" style="margin:0px auto;width:1080px;margin-top:20px;">
					<font style="font-size:14px;font-weight:bold;font-color:#666666;">Choose your method of payment</font>
				</div>
				
				<div style="margin:0px auto;width:1080px; height:200px;"> 
            			<label style="width:550px;">
							<input type="radio" name="paytype"  style="margin-right:8px;" value="1" checked=true onclick="changetype(1);"/>
							<img width=113px height=29px src="../Public/image/paypal.jpg" />								  							
						</label> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						<label>
							<input type="radio" name="paytype"   value="2" style="margin-right:8px;" onclick="changetype(2);"/>
						  <img src="../Public/image/stripecards.png" />
						</label>
				</div>
			</div> <!--  end payment-2 -->
			
			<!-- payment2 info area -->
				<div  id="cardinfo" style="display:none;margin:0px auto;width:1080px;height:80px;margin-top:10px;
				border-top-width: 1px;border-top-style: solid;border-top-color: #DDD;" >

					<div style="margin-top:22px;height:50px;">
						<font style="font-size:14px;font-color:#666666;">	cardNo</font>&nbsp;
					<input type="text" style="width:290px;"  id="cardno" name="cardno" class="card-input" placeholder="card number"/>
					&nbsp;&nbsp;
					<font style="font-size:14px;font-color:#666666;">	expiredate</font>&nbsp;
					<input type="text"   id="expmonth" name="expmonth" class="card-input" placeholder="expmonth"/>&nbsp;
					/ &nbsp;<input type="text"   id="expyear" name="expyear" class="card-input" placeholder="expyear"/>
					&nbsp;&nbsp;
					<font style="font-size:14px;font-color:#666666;">	cvc</font>&nbsp;
					<input type="text"  id="cvc" name="cvc" class="card-input"/>
					</div >
						
			    </div>
					
						
			<div id="receipt" style="margin:0px auto;width:1080px;height:30px;margin-top:80px;"> 
				  <img src="../Public/image/checkout_icon3.png" style="width:17px;height:22px;float:left;padding-left:10px;"/>
				  <font style="font-size:16px;font-weight:bold;color:#884697;padding-left:5px;">Receipt</font>
			</div>

			<div id="receipt-2" style="margin:0px auto;width:1080px;height:200px;margin-top:5px;
				border-top-width: 1px;border-top-style: solid;border-top-color: #884697;"">
				
				<div style="margin:0px auto;width:1080px;height:140px;margin-top:10px;">
					<div style="width:500px;height:140px;float:left;">
						<font style="font-family:'Century Gothic';font-size:14px;font-color:#666666;font-weight:bold;">Electronic receipt of purchase </font>
					  <font style="font-family:'Century Gothic';font-size:14px;font-color:#888888;"><br>This receipt will be sent to you once the order has been confirmed. This receipt can be regarded as an official document and can be used for product warranty ans maintenance requests.</font>
					</div>
					
					<div style="height:140px; width:500px;margin-left:550px;margin-top:40px;">
					  <font style="font-family:'Century Gothic';font-size:12px;">e-mail *</font>
					  <input name="email"  id="email"type="text" class="shipping-input" style="width:250px;" value="your e-mail address"
					  onfocus="if (value =='your e-mail address'){value ='';this.style.color='#333'}" onblur="if (value ==''){ value='your e-mail address';this.style.color='#999'}"/>
				  </div>
				</div>
			</div>
<!--下面为订单信息-->
	<div id="confire" style="margin:0px auto;width:1080px;height:30px;border-bottom-width: 1px;border-bottom-style: solid;border-bottom-color: #884697;">
				  <img src="../Public/image/checkout_icon4.png" style="width:22px;height:20px;float:left;padding-left:10px;"/>
				  <font style="font-size:16px;font-weight:bold;color:#884697;padding-left:5px;">Order Confirmation</font>
	</div>


	<div style="margin:0px auto;width:1080px;height:50px;background-color:#884697;">
		<div class="cart_title" style="width:400px;margin-left:20px;">Product</div>
		<div class="cart_title">color</div>
		<div class="cart_title">qty</div>
		<div class="cart_title">price</div>
		<div class="cart_title">total</div>
	</div>


  	<div id='OrderConfirmation' style="margin:0px auto;width:1080px;">
	
    <ul>
    <volist name="cartlist" id="vo"> 
    	<li id="{$vo['productid']}" style="margin-top:20px;">
    		<div class="item_div">    
      		<div class="field_div" style="width:100px;margin-left:20px;padding-top:0px;"><img src="{$vo['background_img']}" style="width:100px;height:75px;"/></div>    		
      		<div class="field_div" style="width:300px;padding-top:20px;">{$vo['title']}</div>
      		<div class="field_div" ><notempty name="vo.typepic"><img src="{$vo['typepic']}" style="width:10px;height:10px;"/><else/>--</notempty></div>
      		<div class="field_div"> {$vo['qty']}</div>  
      		<div class="field_div">{$vo['price']}</div>
			<div class="field_div">${$vo['total']}</div>
			</div>
       </li>      
    </volist>
      	<li>
			<div id="confire-4" style="margin:0px auto;width:1080px;height:40px;margin-top:10px;">
				  <div style="height:40px;float:right;margin-right:100px;margin-top:5px;">
					<font class="confiretext1">items: </font> 
					<font class="confiretext2">{$qty}</font>
					<font class="confiretext1"> pcs &nbsp;&nbsp; shipping: </font>    
					<font id="ship-price" class="confiretext2"></font>  
					<font class="confiretext1">   &nbsp;&nbsp;total: </font>   
					<font id="total-price" class="confiretext2"> &nbsp;&nbsp; {$allo_total}</font>
				  </div>
			</div>
      	</li>
		<li>
			<div id="confire-5" style="margin:0px auto;width:1080px;height:150px;margin-top:30px;">
					<div style="margin:0px auto;width:300px;height:150px;margin-top:10px;">
						<input type="button" id="buy" style="margin:0px auto;background-image:url(../Public/image/checkout_1.1.png);
							   font-size: 18px;font-weight: bold;color:#FFF;background-color: transparent;
							   width:265px;height:50px;" value="Go to payment" />
					</div>
			</div>
		</li>
    </ul>
  
  
  </div>


<!--<include file="Home:bottom"/> -->


<!--下面信息为在支付完成的时候显示-->

	<div id="succ" style="text-align:center;display: none;">
		<div style="margin:0px auto;">
			<img  src="../Public/image/checkout_success.png" style="width:79px;height:79px;margin:0px auto;"/>
		</div>
		<div style="margin:0px auto;margin-top:30px;">
			<font style="font-size:20px;color:#884697;"> Congratulations! </font>
		</div>
		<div id="succinfo" style="text-align:left;margin:5px auto;margin-top:30px;padding:40px;font-size:14px;font-color:#666666;">	
			
		</div>
		
		<div style="margin:0px auto;padding:40px;width:265px;height:50px; ">
			<input type="button" style="background-image:url(../Public/image/checkout_1.1.png);
				font-size: 18px;color:#FFF;background-color: transparent;
			 width:265px;height:50px;"value="OK" onclick="closeart('des');"/>
              
		</div>

    </div>
  
    <div id="fail" style="text-align:center;display: none;">
		<div style="margin:0px auto;">
			<img  src="../Public/image/checkout_fail.png" style="width:79px;height:79px;margin:0px auto;"/>
		</div>
		<div style="margin:0px auto;margin-top:30px;">
			<font style="font-size:20px;color:#884697;"> Fail to pay! </font>
		</div>
		<div style="text-align:left;margin:5px auto;margin-top:30px;padding:40px;font-size:14px;font-color:#666666;" id="info">	
			Sorry, unfortunately the payment failed. Please check whether all information is correct and try again.
		</div>
    
    	<div style="margin:0px auto;padding:40px;width:265px;height:50px; ">
			<input type="button" style="background-image:url(../Public/image/checkout_1.1.png);
				font-size: 18px;color:#FFF;background-color: transparent;
			 width:265px;height:50px;"value="OK" onclick="closeart('des2');"/>
              
		</div>
		
		
		  
  	</div>
  
</div>
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>	
<script type="text/javascript">
	$(document).ready(function()
	{
			document.getElementById("pathguide").innerHTML +=' > '+ "check out";
			//document.getElementById("shop_img").src='../Public/image/shop_unselect.png';			
	});
		
	var rs = 1;	
	var token;
	var type;
	
	function checkinput()
	{
  		rs = 1;
  		
  		//check input										
			$("input[type='text']").each(function(index, element) {
  			if (this.value == '' && (this.name != 'company' && this.name != 'cardno'
  			  && this.name != 'expmonth' && this.name != 'cvc' && this.name != 'expyear'))
  			{			 
  					rs = 0;
  					//tip(this.name+' cannot be empty!');
  					document.getElementById("msg").innerHTML = this.name+' cannot be empty!';
  					document.getElementById("msgbox").style.display="block";
  					scrollTo(400,100);
  					return false;
  			}
			
  			if( (this.name == 'firstname' && this.value == 'First Name') ||
  			 (this.name == 'lastname' && this.value == 'Last Name') ||
  			 (this.name == 'phone' && this.value == 'Your Phone Number') ||
  			 (this.name == 'address' && this.value == 'Address') || 
  			 (this.name == 'postcode' && this.value == 'Postal Code') || 
  			 (this.name == 'city' && this.value == 'City'))
  			{  rs = 0;
  				 document.getElementById("msg").innerHTML = this.name+' cannot be empty!';
  					document.getElementById("msgbox").style.display="block"; 
  					scrollTo(400,100);
  					return false;
  			}
			
			
  			if (this.name == 'email') {
  				if (!(/^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/.test(this.value))) {
  					rs = 0;
  					//tip('Please enter a valid mailbox!');
  					document.getElementById("msg").innerHTML = 'Please enter a valid mailbox!';
  					document.getElementById("msgbox").style.display="block"; 
  					//window.location.hash = "#msgbox";
  					scrollTo(400,100); 
  					return false;
  				}
  			}
	   	});
	   	
	   	if(document.getElementById("countrylist").value==-1)
			{ rs = 0;
				document.getElementById("msg").innerHTML = 'Please choose your country!';
				document.getElementById("msgbox").style.display="block"; 
				scrollTo(400,100); 
				return false;
			}
			
			return true;
	}

	function ship_price()
	{
		var currency = "$";
			if(document.getElementById("countrylist").value==-1)
			  document.getElementById("countrylist") .style.color='#999';
			else
				document.getElementById("countrylist") .style.color='#333';
			
			var url = "{:U('Cart/shipPrice')}";
			var data =  { countryid: document.getElementById("countrylist").value,allo_total:{$allo_total}};

			$.post(url,data,function(data,status){
						if(status == "success"){
							document.getElementById("ship-price").innerHTML = currency+data.ship_price;
							document.getElementById("total-price").innerHTML = currency+data.allo_pay_total;
							document.getElementById("buy").disabled = false;
							//window.location.reload();
						}else{
							alert(data.msg);
							document.getElementById("buy").disabled = true;
											
						}
					},"json"); 
						 
	}
	
	function closeart(dialogid)
		{
			window.top.art.dialog({id:dialogid}).close();
		}

	function changetype(paytype)
	{
		if (paytype == 2)
			document.getElementById('cardinfo').style.display="block";
		else
			document.getElementById('cardinfo').style.display="none";
	}

	$(function() {
		$("#buy").click(function() {
			var result = checkinput();
			if(!result)
				return false;

			//if pay using card, check card input first
			type = 1;
			var paytype = document.getElementsByName("paytype");
			for(var i=0;i<paytype.length;i++){
				if(paytype[i].checked)
					type = paytype[i].value;
			}
			//点击提交的时候 首先判断输入的卡的信息是否为空
			if(type==2)
			{
				if(document.getElementById("cardno").value=='' || document.getElementById("expmonth").value==''
						|| document.getElementById("expyear").value=='' || document.getElementById("cvc").value=='')
				{
					document.getElementById("msg").innerHTML = 'please input card info !';
					document.getElementById("msgbox").style.display="block";
					scrollTo(400,100);
					return false;
				}

			}

			//if pay using card,generate stripe token first
			if(type==2)
			{
				//下面这两个都没有
//				document.getElementById("loading").style.display='block';
//				document.getElementById("loading2").style.display='block';

				Stripe.setPublishableKey('{:C('STRIPE_PK')}');//'pk_test_u1F10fuUigV8J5gnJjvsAgHg'
				//根据提供的卡的信息在stripe.js 库中创建一个令牌
				Stripe.card.createToken({
					number: document.getElementById("cardno").value,
					cvc: document.getElementById("cvc").value,
					exp_month: document.getElementById("expmonth").value,
					exp_year: document.getElementById("expyear").value
				}, stripeResponseHandler);
			}
			if(type==1) {
				//document.getElementById("loading").style.height = $(document.body).height();//document.body.clientHeight;//(document.body).height();
				submitPay();
			}
		});
	});
	function stripeResponseHandler(status, response) {
		if (response.error) {
//			document.getElementById("loading").style.display='none';
//			document.getElementById("loading2").style.display='none';
			// Show the errors on the form
			document.getElementById("msg").innerHTML = 'invalid card info !';
			document.getElementById("msgbox").style.display="block";
			scrollTo(400,100);
			alert('invalid card info!');
			rs = 0;
			window.location = '/DesignNest/index';
			return false;

		} else {
			//document.getElementById("loading").height = $(window).height();//document.body.clientHeight;//(document.body).height();

			// response contains id and card, which contains additional card details
			token = response.id;
			submitPay();
		}
	}
	//submit pay info
	//document.getElementById("loading").style.display='block';
	//alert(document.getElementById("city").value);
	function submitPay()
	{
		if(rs != 1)
		{
			return false;
		}

			//record into database[ajax],then pay
			var url = "{:U('Cart/submit_order')}";
			var price = '{$price}';
			var data =  {
				stripetoken: token,
				cardno: document.getElementById("cardno").value,
				expmonth: document.getElementById("expmonth").value,
				expyear: document.getElementById("expyear").value,
				cvc: document.getElementById("cvc").value,
				paytype:type,
				first_name:document.getElementById("firstname").value,
				last_name:document.getElementById("lastname").value,
				phone:document.getElementById("phone").value,
				company:document.getElementById("company").value,
				countryid: document.getElementById("countrylist").value,
				address: document.getElementById("address").value,
				city: document.getElementById("city").value,
				zip: document.getElementById("postcode").value,
//				countryid: document.getElementById("countrylist").value,
				email:document.getElementById("email").value,
				qty: '{$qty}',
				designwinner_id: '{$designwinner_id}',
				designwinner_title: '{$title}',
				price_id: '{$typeid}',
				typename: '{$typename}',
				price: '{$price}' ,
				shipfee:document.getElementById("ship-price").innerHTML,
				total:document.getElementById("total-price").innerHTML};

		  $.post(url,data,function(data){
					if(data.status != 1){
						fail(data['msg']);
						return false;
					}
					else//open paypal url,
					{
						if(type==1)
						  window.location = data.paymenturl; //alert(data.paymenturl);
						if(type==2)
						  congratulation();
					}
			},"json");
	}

	//tip user that pay successfully
	function congratulation()
	{
//		document.getElementById("loading").style.display='none';
//document.getElementById("loading2").style.display='none';
		var window_height = $(window).height();
			if(window_height<800)
			{
				maxHeight=window_height*0.7;
				_top=0;
				_width='80%';
			}else{
				maxHeight='600px';
				_top='115px';
				_width='60%';
			}
			var id = $(this).data("id");

			$('#succ').css('overflow', 'auto');
			$('#succ').css('maxHeight',maxHeight);
			document.getElementById("succinfo").innerHTML="Thanks for ordering our products!We will send your order information to the address "
			+ document.getElementById("email").value
			+ " and ship the goods as soon as possible. We would like to thank you for your support  so please do not hesitate to contact us if you have any further questions!	";

			art.dialog({
					id: 'des',
					title: "Congratulations!",
					content: document.getElementById("succ"),
					width: _width,
					top:_top,
					lock: true,
					close: function(){
						window.location = '/DesignNest/index';
					 }
				}

);

	}

	function fail(msg)
	{
		document.getElementById('fail').innerHTML="Sorry, unfortunately the payment failed. Please check whether all information is correct and try again.<br/>"+msg;
//		document.getElementById("loading").style.display='none';
//		document.getElementById("loading2").style.display='none';
		var window_height = $(window).height();
			if(window_height<800)
			{
				maxHeight=window_height*0.7;
				_top=0;
				_width='80%';
			}else{
				maxHeight='600px';
				_top='115px';
				_width='60%';
			}
			var id = $(this).data("id");

			$('#fail').css('overflow', 'auto');
			$('#fail').css('maxHeight',maxHeight);

			art.dialog({
					id: 'des2',
					title: "Fail to pay!",
					content: document.getElementById("fail"),
					width: _width,
					top:_top,
					lock: true,
					close: function(){
						window.location = '/Cart/checkout';
					 }
				}

);


						//document.getElementById("msg").innerHTML = 'Sorry,fail to submit!';
						//alert(data.msg);

						//congratulation


	}
</script>
	
<style type="text/css">
			
.type{width:18px;height:18px;margin-left:10px;border:1px solid;}
.shipping-div{float:left;margin-left:10px;width:610px;height:40px;padding-top:5px;
	color:#999;
	}
.shipping-field{width:40px;float:left;}
.card-input{padding-left:5px;height:40px;width:50px;font-size:12px;font-color:#999999;margin:0px auto;margin-left:5px;border:1px solid #CCC;background-color:#EEE;}

.shipping-input{padding-left:10px;height:30px;margin:0px auto;width:500px;margin-left:50px;border:1px solid #CCC;
	font-size:12px;color:#999999;background-color:#EEE;}
.payment-select{width:160px;height:50px;margin-top:5px;margin-right:400px;float:right;}
.confire-item{float:left;text-align:center; font-weight:bold;font-size:20px;color:#884697;width:120px;padding-left:40px;margin-top:15px;}
.confire-item2{float:left;text-align:center; font-weight:bold;font-size:20px;color:#884697;width:120px;padding-left:40px;margin-top:35px;}
.confiretext1{font-size:18px;color:#666666;}
.confiretext2{font-size:18px;font-weight:bold;color:#884697;}
</style>